{% extends 'SyliusAdminBundle::layout.html.twig' %}

{% import '@AcmeSyliusTranslationPlugin/macro.html.twig' as pluginMacro %}

{% set locales = plugin.getSyliusAvailableLocales() %}
{% set defaultLocale = plugin.getSyliusDefaultLocale() %}
{% set currentLocale = plugin.getLocale() %}
{% set domains = plugin.getMessageCatalogue().getDomains() %}
{% set customDomains = plugin.getCustomMessageCatalogue().getDomains() %}

{% block title %}{{ 'Translation'|trans({}, null, currentLocale.code) }} | Sylius{% endblock %}

{% block stylesheets %}
    {% include 'SyliusUiBundle::_stylesheets.html.twig' with {'path': 'assets/admin/css/style.css'} %}
    {{ sonata_block_render_event('sylius.admin.layout.stylesheets') }}
    <style>
        .hidden { display:none !important; }
    </style>
{% endblock %}

{% block javascripts %}
    {% include 'SyliusUiBundle::_javascripts.html.twig' with {'path': 'assets/admin/js/app.js'} %}
    {{ sonata_block_render_event('sylius.admin.layout.javascripts') }}


    <script>
        function stpEditMessage(selector)
        {
            const
                container = jQuery(selector),
                localeCode = container.find('form input[name="localeCode"]').val(),
                domain = container.find('form input[name="domain"]').val(),
                messageDomain = container.find('form input[name="messageDomain"]').val(),
                translation = container.find('form input[name="translation"]').val();
            if(newTranslation = prompt(messageDomain + '\n(' + localeCode + ')', translation))
            {
                jQuery.post(
                    '/admin/translation/set',
                    {
                        'localeCode': localeCode,
                        'domain': domain,
                        'messageDomain': messageDomain,
                        'translation': newTranslation
                    }, function(response) {
                        if(response.status == 'success')
                        {
                            container.find('form input[name="translation"]').val(newTranslation);
                            container.find('span.translation').text(newTranslation);
                            // show notification
                        }
                        else alert('something wrong');
                    }, 'json');
            }
        }
    </script>
{% endblock %}

{% block content %}

{% set title = currentLocale.name|trans([], null, defaultLocale.code) %}
{% set description = 'translation_overview'|trans({'%someData%': ''}, 'SyliusTranslationPlugin', defaultLocale.code) %}

{% include 'AcmeSyliusTranslationPlugin::_header.html.twig' with {'title': title, 'description': description, 'icon': 'flag ' ~ currentLocale.code} %}

{% if locales|length > 1 %}
<div class="ui segment overflow-x-auto">
    {% for locale in locales %}
        {{ pluginMacro.localeButton(locale, currentLocale) }}
    {% endfor %}
</div>
{% endif %}

{% if domains|length > 0 %}
<div class="ui segment overflow-x-auto">
    {% for domain in domains %}
        {{ pluginMacro.domainButton(domain, currentLocale) }}
    {% endfor %}
</div>
<!--
<div class="ui segment overflow-x-auto">
    <select id="domainFilter">
        <option value="">All</option>
    {% for domain in domains %}
        <option value="{{ domain }}">{{ domain }}</option>
    {% endfor %}
    </select>
    <input type="text" id="messageFilter">
    <label><input type="checkbox"> Include domain names</label>
</div>
-->
{% endif %}

<div class="ui segment overflow-x-auto">
    {% set selectedDomain = null %}
    {% if app.request.query.get('domain') in domains %}
        {% set selectedDomain = app.request.query.get('domain') %}
    {% endif %}
    {% for domain in domains %}
        {% set showDomainMessages = true %}
        {% if selectedDomain != null and domain != selectedDomain %}
            {% set showDomainMessages = false %}
        {% endif %}
        {% if showDomainMessages %}
            {% set messages = plugin.getMessageCatalogue.all(domain) %}
            {% if messages|length > 0 %}
    <h3>{{ domain }}</h3>
    <table class="ui sortable stackable celled table">
        <thead>
        <tr>
            <th>Domain</th>
            <th>Message</th>
        </tr>
        </thead>
        <tbody>
            {% for messageDomain, translation in messages %}
                {% set url = path('sylius_translation_plugin_translation_set_message', {'localeCode': currentLocale.code, 'domain': domain, 'messageDomain': messageDomain }) %}
                {% set messageSelectorSuffix = '%s_%s'|format(domain, loop.index) %}
            <tr>
                <td>{{ messageDomain }}</td>
                <td>
                    <div id="message_container_{{ messageSelectorSuffix }}">
                        {# TODO: hardcoded #}
                        <form method="POST" action="{{ url }}" class="hidden" method="POST">
                            <input type="hidden" value="{{ currentLocale.code }}" name="localeCode" />
                            <input type="hidden" value="{{ domain }}" name="domain" />
                            <input type="hidden" value="{{ messageDomain }}" name="messageDomain" />
                            <input type="hidden" value="{{ translation }}" name="translation" />
                        </form>
                        <span class="translation">{{ translation }}</span>
                        <a class="ui labeled icon button edit right" href="#" onclick="stpEditMessage('#message_container_{{ messageSelectorSuffix }}')">
                            <i class="icon edit"></i> Edit
                        </a>
                        <input type="text" class="hidden" class="newTranslation">
                        <a class="ui labeled icon button edit right hidden" href="#" onclick="stpConfirmEdit('#message_container_{{ messageSelectorSuffix }}')">
                            <i class="icon edit"></i> Edit
                        </a>
                        <a class="ui labeled icon button edit right hidden" href="#" onclick="stpCancelEdit('#message_container_{{ messageSelectorSuffix }}')">
                            <i class="icon edit"></i> Edit
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
            {% endif %}
        {% endif %}
    {% endfor %}
</div>
{% endblock %}
